<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vancouver Rehome - 华诚家具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading-dots:after { content: ' .'; animation: dots 1s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
        40% { color: #666; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
        60% { text-shadow: .25em 0 0 #666, .5em 0 0 rgba(0,0,0,0); }
        80%, 100% { text-shadow: .25em 0 0 #666, .5em 0 0 #666; } }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans min-h-screen flex flex-col">

    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-blue-600">Vancouver Rehome 华诚家具</h1>
            <a href="https://www.icloud.com/sharedalbum/#B25G4Tcsm0bvhGG" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition">打开 iCloud 相册</a>
        </div>
    </nav>

    <header class="max-w-6xl mx-auto px-4 py-8 text-center">
        <h2 class="text-3xl font-extrabold mb-2 text-gray-800">温哥华二手家具中心</h2>
        <p class="text-gray-600 italic">优质现货 · 每日更新 · 诚信经营</p>
        <div class="mt-4 inline-block bg-blue-50 text-blue-700 px-4 py-1 rounded-full text-sm border border-blue-100">
            微信联系看货：(请在此处修改你的微信号)
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 pb-12 flex-grow">
        <div id="gallery" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <div id="loading" class="col-span-full py-20 text-center text-gray-500">
                <p class="text-lg loading-dots font-medium">正在从云端同步最新家具照片</p>
                <p class="text-xs mt-2 text-gray-400">首次加载可能需要几秒钟，请稍候</p>
            </div>
        </div>
    </main>

    <footer class="bg-gray-100 py-8 border-t border-gray-200">
        <div class="text-center text-gray-400 text-sm">
            &copy; 2024 Vancouver Rehome 华诚家具<br>
            Powered by iCloud Shared Album
        </div>
    </footer>

    <script>
        // 【核心配置】你的 iCloud 共享相册链接
        const icloudLink = 'https://www.icloud.com/sharedalbum/#B25G4Tcsm0bvhGG';

        async function fetchICloudPhotos() {
            const gallery = document.getElementById('gallery');
            const loading = document.getElementById('loading');
            
            try {
                // 1. 获取相册 Token
                const albumToken = icloudLink.split('#')[1];
                if (!albumToken) throw new Error('链接格式不正确');

                // 2. 向 iCloud 服务器请求数据 (使用通用的 p23 节点)
                const response = await fetch(`https://p23-sharedstreams.icloud.com/${albumToken}/sharedstreams/webstream`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ streamGuid: albumToken })
                });

                if (!response.ok) throw new Error('iCloud 服务器响应错误');

                const data = await response.json();
                
                // 3. 提取照片列表
                const photos = data.photos;
                if (!photos || photos.length === 0) {
                    loading.innerHTML = `
                        <div class="p-8 border-2 border-dashed border-gray-200 rounded-xl">
                            <p class="text-gray-500">相册内暂无照片</p>
                            <p class="text-sm text-gray-400 mt-2">请在 iPhone 的“家具”共享相册中添加图片，并确保“公共网站”开关已打开。</p>
                        </div>`;
                    return;
                }

                // 4. 清除加载动画
                loading.remove();

                // 5. 倒序排列（最新的家具排在前面）
                photos.reverse().slice(0, 100).forEach(photo => {
                    // 拼接图片的真实下载地址
                    const itemGuid = photo.itemGuid;
                    const urlInfo = data.items[itemGuid];
                    if (!urlInfo) return;

                    const photoUrl = `https://${urlInfo.url_location}${urlInfo.url_path}`;
                    
                    // 生成 HTML 卡片
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition duration-300 group cursor-pointer';
                    card.innerHTML = `
                        <div class="aspect-[4/3] bg-gray-100 overflow-hidden">
                            <img src="${photoUrl}" 
                                 class="w-full h-full object-cover group-hover:scale-105 transition duration-500" 
                                 loading="lazy"
                                 onerror="this.src='https://via.placeholder.com/400x300?text=图片加载中...'">
                        </div>
                    `;
                    gallery.appendChild(card);
                });

            } catch (error) {
                console.error('加载出错:', error);
                loading.innerHTML = `
                    <div class="text-red-500 p-8">
                        <p class="font-bold">照片同步暂时中断</p>
                        <p class="text-sm mt-2 text-gray-600">原因可能有：<br>1. iPhone 上的“公共网站”开关被关闭了<br>2. 链接已过期<br>3. 网络连接不稳定</p>
                        <button onclick="location.reload()" class="mt-4 bg-gray-200 text-gray-700 px-4 py-2 rounded-md text-sm">点击重试</button>
                    </div>`;
            }
        }

        // 页面加载完成后立即执行
        window.onload = fetchICloudPhotos;
    </script>
</body>
</html>
