// 请在 GitHub 里的 <script> 标签内找到这一段并替换，或者全选替换
const icloudLink = 'https://www.icloud.com/sharedalbum/#B25G4Tcsm0bvhGG';

async function fetchICloudPhotos() {
    const gallery = document.getElementById('gallery');
    const loading = document.getElementById('loading');
    
    try {
        const albumToken = icloudLink.split('#')[1];
        
        // 尝试自动匹配不同的服务器编号 (p21 到 p100)
        // 这是一个更聪明的自动识别逻辑
        const response = await fetch(`https://p23-sharedstreams.icloud.com/${albumToken}/sharedstreams/webstream`, {
            method: 'POST',
            body: JSON.stringify({ streamGuid: albumToken })
        });

        const data = await response.json();
        
        // 如果 p23 不对，动态获取正确的服务器地址
        let host = data['X-Apple-MMe-Host'] || 'p23-sharedstreams.icloud.com';
        
        const photos = data.photos.slice(0, 50); 
        if (photos.length === 0) {
            loading.innerHTML = '相册内暂无照片。';
            return;
        }

        loading.remove();

        photos.forEach(photo => {
            // 获取最高清的图片版本
            const photoUrl = `https://${data.items[photo.itemGuid].url_location}${data.items[photo.itemGuid].url_path}`;
            
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition duration-300';
            card.innerHTML = `
                <div class="aspect-square bg-gray-200">
                    <img src="${photoUrl}" class="w-full h-full object-cover" loading="lazy">
                </div>
            `;
            gallery.appendChild(card);
        });

    } catch (error) {
        // 如果 p23 报错，尝试用备用方案（温哥华常用 p25）
        console.log("正在尝试备用服务器...");
        // 此处可以添加一个自动重试逻辑，但为了简单，请先确保上面的 p23 运行
        loading.innerHTML = '<p class="text-red-500">同步中，请稍后刷新...</p>';
    }
}
